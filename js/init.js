/**
 * Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† - Ù…Ù„Ù Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
 * ØªØ´ØºÙŠÙ„ ÙˆØ±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
 */

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
window.appConfig = {
    version: '1.0.0',
    name: 'Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
    isOnline: navigator.onLine,
    currentUser: null,
    initialized: false
};

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async function initializeApplication() {
    try {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†...');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        showInitialLoadingScreen();
        
        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ“Š ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        const dbInitialized = await database.init();
        if (!dbInitialized) {
            throw new Error('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...');
        await app.init();
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ØªÙ†Ù‚Ù„
        console.log('ğŸ§­ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„...');
        await navigationManager.init();
        
        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        updateOnlineStatus();
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©
        setupGlobalEventListeners();
        
        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        await registerServiceWorker();
        
        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        hideInitialLoadingScreen();
        
        // ØªØ³Ø¬ÙŠÙ„ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        window.appConfig.initialized = true;
        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!');
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
        setTimeout(() => {
            app.showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†', 'success', 3000);
        }, 1000);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
        showInitializationError(error);
    }
}

function showInitialLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.style.display = 'flex';
        loadingScreen.querySelector('p').textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...';
    }
}

function hideInitialLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
            loadingScreen.style.display = 'none';
        }, 500);
    }
}

function showInitializationError(error) {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.innerHTML = `
            <div class="spinner-container">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4>Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h4>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                </div>
            </div>
        `;
    }
}

async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('./sw.js');
            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ù†Ø¬Ø§Ø­:', registration.scope);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ­Ø¯ÙŠØ«Ø§Øª
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        app.showNotification('ÙŠØªÙˆÙØ± ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚. Ø³ÙŠØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„.', 'info', 8000);
                    }
                });
            });
            
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
        }
    }
}

function setupGlobalEventListeners() {
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    // document.addEventListener('contextmenu', (e) => e.preventDefault());
    
    // Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') ||
            (e.ctrlKey && e.shiftKey && e.key === 'C') ||
            (e.ctrlKey && e.key === 'U')) {
            // e.preventDefault(); // ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
        }
    });
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    window.addEventListener('resize', handleWindowResize);
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

function updateOnlineStatus() {
    window.appConfig.isOnline = navigator.onLine;
    const statusElement = document.querySelector('.connection-status');
    
    if (navigator.onLine) {
        console.log('ğŸŒ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
        if (statusElement) {
            statusElement.className = 'connection-status online';
            statusElement.innerHTML = '<i class="fas fa-wifi"></i> Ù…ØªØµÙ„';
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        if (app && app.syncPendingData) {
            app.syncPendingData();
        }
    } else {
        console.log('ğŸ“± ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„');
        if (statusElement) {
            statusElement.className = 'connection-status offline';
            statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i> ØºÙŠØ± Ù…ØªØµÙ„';
        }
    }
}

function handleWindowResize() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø·ÙŠØ· Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    const isMobile = window.innerWidth < 768;
    document.body.classList.toggle('mobile-view', isMobile);
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (window.dashboardManager && window.dashboardManager.charts) {
        Object.values(window.dashboardManager.charts).forEach(chart => {
            if (chart && chart.resize) {
                chart.resize();
            }
        });
    }
}

function handleBeforeUnload(e) {
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
    if (app && app.saveAllPendingData) {
        app.saveAllPendingData();
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
    const hasUnsavedChanges = checkForUnsavedChanges();
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
        return e.returnValue;
    }
}

function checkForUnsavedChanges() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
    const changedForms = document.querySelectorAll('form.changed');
    const unsavedButtons = document.querySelectorAll('.btn-warning[onclick*="save"]');
    
    return changedForms.length > 0 || unsavedButtons.length > 0;
}

function handleVisibilityChange() {
    if (document.hidden) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºØ§Ø¯Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        console.log('ğŸ‘ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºØ§Ø¯Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨');
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        if (window.dashboardManager && window.dashboardManager.stopAutoRefresh) {
            window.dashboardManager.stopAutoRefresh();
        }
    } else {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ Ù„Ù„ØªØ¨ÙˆÙŠØ¨
        console.log('ğŸ‘ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ Ù„Ù„ØªØ¨ÙˆÙŠØ¨');
        
        // Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        if (window.dashboardManager && window.dashboardManager.startAutoRefresh) {
            window.dashboardManager.startAutoRefresh();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (navigationManager && navigationManager.refreshCurrentSection) {
            navigationManager.refreshCurrentSection();
        }
    }
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø©
window.appUtils = {
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    formatDate: (date, locale = 'ar-DZ') => {
        return new Date(date).toLocaleDateString(locale);
    },
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
    formatTime: (time, locale = 'ar-DZ') => {
        return new Date(`2000-01-01T${time}`).toLocaleTimeString(locale, {
            hour: '2-digit',
            minute: '2-digit'
        });
    },
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    formatNumber: (number, locale = 'ar-DZ') => {
        return new Intl.NumberFormat(locale).format(number);
    },
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    arabicToEnglishNumbers: (str) => {
        const arabicNumbers = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
        const englishNumbers = '0123456789';
        return str.replace(/[Ù -Ù©]/g, (char) => {
            return englishNumbers[arabicNumbers.indexOf(char)];
        });
    },
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ù‰ Ø¹Ø±Ø¨ÙŠØ©
    englishToArabicNumbers: (str) => {
        const arabicNumbers = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
        const englishNumbers = '0123456789';
        return str.replace(/[0-9]/g, (char) => {
            return arabicNumbers[englishNumbers.indexOf(char)];
        });
    },
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    validateEmail: (email) => {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ
    validateAlgerianPhone: (phone) => {
        const phoneRegex = /^(\+213|0)(5|6|7)[0-9]{8}$/;
        return phoneRegex.test(phone);
    },
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
    generateId: () => {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    },
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ
    sanitizeText: (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    // ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ base64
    imageToBase64: (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
};

// Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
window.quickQueries = {
    // Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
    getActiveTrainees: async () => {
        const trainees = await database.getAllTrainees();
        return trainees.filter(t => t.status === 'active');
    },
    
    // Ø¬Ù„Ø¨ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…
    getTodayAttendance: async () => {
        const today = new Date().toISOString().split('T')[0];
        return await database.getAttendanceByDate(today);
    },
    
    // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
    calculateAttendanceRate: async (traineeId, startDate, endDate) => {
        const attendance = await database.getAttendanceByTrainee(traineeId, startDate, endDate);
        const totalDays = attendance.length;
        const presentDays = attendance.filter(a => a.status === 'present' || a.status === 'late').length;
        return totalDays > 0 ? (presentDays / totalDays * 100).toFixed(1) : 0;
    }
};

// Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
function addConnectionStatusBar() {
    if (!document.querySelector('.connection-status')) {
        const statusBar = document.createElement('div');
        statusBar.className = 'connection-status';
        statusBar.style.cssText = `
            position: fixed;
            top: 70px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1050;
            transition: all 0.3s ease;
        `;
        document.body.appendChild(statusBar);
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ DOM
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ DOMØŒ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...');
    
    // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    addConnectionStatusBar();
    
    // Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    initializeApplication();
});

// ØªØµØ¯ÙŠØ± Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
window.initializeApplication = initializeApplication;
window.updateOnlineStatus = updateOnlineStatus;